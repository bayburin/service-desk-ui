<ng-template #rt let-r="result">{{r.name}}</ng-template>

<form [formGroup]="caseForm" (ngSubmit)="onSubmit()">
  <div class="row">
    <div class="col-sm">
      <div class="form-group">
        <label for="user_tn">Табельный номер</label>
        <input type="text" id="user_tn" name="user_tn" formControlName="user_tn" class="form-control" placeholder="Табельный номер">
      </div>
    </div>
    <div class="col-sm">
      <div class="form-group">
        <label for="fio">ФИО</label>
        <input type="text" id="fio" name="fio" formControlName="fio" class="form-control" placeholder="ФИО">
      </div>
    </div>
    <div class="col-sm">
      <div class="form-group">
        <label for="dept">Подразделение</label>
        <input type="text" id="dept" name="dept" formControlName="dept" class="form-control" placeholder="Подразделение">
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm">
      <div class="form-group">
        <label for="email">Электронная почта</label>
        <input type="text" id="email" name="email" formControlName="email" class="form-control" placeholder="Электронная почта">
      </div>
    </div>
    <div class="col-sm">
      <div class="form-group">
        <label for="phone">Рабочий телефон</label>
        <input type="text" id="phone" name="phone" formControlName="phone" class="form-control" placeholder="Рабочий телефон">
      </div>
    </div>
    <div class="col-sm">
      <div class="form-group">
        <label for="mobile">Сотовый телефон</label>
        <input type="text" id="mobile" name="mobile" formControlName="mobile" class="form-control" placeholder="Сотовый телефон">
      </div>
    </div>
  </div>

  <div class="form-group row">
    <label for="service" class="col-sm-2 col-form-label">Выбор услуги</label>
    <div class="col-sm-10">
      <input id="service" name="service" type="text" class="form-control" formControlName="service" [ngbTypeahead]="search" [resultTemplate]="rt"
        [inputFormatter]="formatter" (click)="onService.next($event.target.value)" (focus)="onService.next($event.target.value)" #instance="ngbTypeahead"
        [ngClass]="{ 'is-invalid': (form.service.touched || submitted) && form.service.errors }" autocomplete="off" placeholder="Выберите услугу">
      <div *ngIf="(form.service.touched || submitted) && form.service.errors" class="invalid-feedback">
        <span *ngIf="form.service.errors.required">Необходимо выбрать услугу или поставить галочку, если услуга отсутствует в списке</span>
      </div>
      <div *ngIf="loading.params">Loading...</div>
      <div class="form-check">
        <input type="checkbox" id="without_service" name="without_service" (change)="onSelectCheckbox(form.service)" formControlName="without_service" class="form-check-input">
        <label for="without_service" class="form-check-label">Обращение не связано ни с одним из перечисленных видов услуг</label>
      </div>
    </div>
  </div>

  <div class="form-group row">
    <label for="desc" class="col-sm-2 col-form-label">Описание проблемы</label>
    <div class="col-sm-10">
      <textarea id="desc" name="desc" rows="3" formControlName="desc" class="form-control" placeholder="Введите описание"
        [ngClass]="{ 'is-invalid': (form.desc.touched || submitted) && form.desc.errors }"></textarea>
      <div *ngIf="(form.desc.touched || submitted) && form.desc.errors" class="invalid-feedback">
        <span *ngIf="form.desc.errors.required">Не может быть пустым</span>
      </div>
    </div>
  </div>

  <div class="form-group row">
    <label for="item" class="col-sm-2 col-form-label">Выбор устройства</label>
    <div class="col-sm-10">
      <select id="item" name="item" formControlName="item" class="form-control" [ngClass]="{ 'is-invalid': (form.item.touched || submitted) && form.item.errors }">
        <option value="">Выберите устройство</option>
        <option *ngFor="let item of items; trackBy:item?.id" [ngValue]="item">
          <span>{{ item.type.short_description }}</span>
          <span *ngIf="item.short_item_model">{{ ' ' + (item.short_item_model) + ';' }}</span>
          <span *ngIf="item.invent_num">{{ ' инв. № ' + item.invent_num }}</span>
        </option>
      </select>
      <div *ngIf="(form.item.touched || submitted) && form.item.errors" class="invalid-feedback">
        <span *ngIf="form.item.errors.required">Необходимо выбрать технику или поставить галочку, если обращение не связано с техникой</span>
      </div>
      <div *ngIf="loading.params">Loading...</div>
      <div class="form-check">
        <input type="checkbox" id="without_item" formControlName="without_item" (change)="onSelectCheckbox(form.item)" class="form-check-input">
        <label for="without_item" class="form-check-label">Обращение не связано ни с одним из перечисленных устройств</label>
      </div>
    </div>
  </div>

  <button type="submit" [disabled]="loading.form" class="btn btn-primary">Отправить</button>
  <button (click)="onCancel($event)" class="btn btn-light">Отменить</button>
</form>